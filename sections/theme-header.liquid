{%- assign blockSettings = section.blocks | map: 'settings' -%}

<div class="theme-header align-items--center page-width relative">
  <button class="hamburger-menu flex-grow d--flex justify--start lg-up--align-items-center lg-up--hide" aria-label="Open mobile menu">
    {%- render 'icon-hamburger' -%}
  </button>
  <a href="{{ routes.root_url }}" aria-label="Go to home page" class="logo-container-menu line-height-0 flex-grow flex-shrink-0 flex-center">
    <img class="header-logo" src="{{ 'logo-tcg.svg' | asset_url }}" alt="{{ shop.name | escape }}">
  </a>
  <nav role="navigation" aria-label="Main menu" class="width--100 lg-down--hide">
    <ul class="menu-header list-unstyled d--inline-flex lg-up--align-items-center width--100 justify--center gap-6">
      {%- for link in section.settings.menu.links -%}
        {%- if link.links != blank -%}
          <li class="menu-header__item ml-22 mr-22 color--black">
            <a href="{{ link.url }}" class="menu-nav-link drowpdown-menu link-menu text--semibold d--inline-flex justify--center lg-up--align-items-center gap-4" data-dropdown="{{ forloop.index }}">
              {{- link.title -}}
              {%- render 'icons-sprite-icon', id: 'icon-caret', size: 9, class: 'rotate--90' -%}
            </a>
            <div class="mega-menu sub-menu-{{ forloop.index }} bg-color--white {%- for childlink in link.links -%} {% if childlink.title != 'Column' %} {%- if childlink.links == blank -%} flex-column {%- endif -%} {% break %}{%- endif -%} {%- endfor -%}">
              <ul class="d--flex gap-24 list-unstyled megamenu-padding {%- for childlink in link.links -%} {% if childlink.title != 'Column' %} {%- if childlink.links == blank -%} flex-column {%- endif -%} {% break %}{%- endif -%} {%- endfor -%}">
                {%- for childlink in link.links -%}
                  <li>
                    {%- if childlink -%}
                      <ul class="sub-menu list-unstyled d--flex gap-24 flex-column">
                        {%- for grandchild_link in childlink.links -%}
                          <li class="">
                            <a class="link-submenu" href= "{{ grandchild_link.url }}">
                              {{- grandchild_link.title -}}
                            </a>
                          </li>
                        {%- endfor -%}
                      </ul>
                    {%- else -%}
                      <a href="{{ childlink.url }}" class="{% if childlink.current %}__item--active{% endif %}"{% if childlink.current %} aria-current="page"{% endif %}>
                        {{- childlink.title | escape -}}
                      </a>
                    {%- endif -%}
                  </li>
                {%- endfor -%}
              </ul>
              {%- assign block = blockSettings | where: 'title', link.title | first -%}
              {%- if block -%}
                <div class="mega-menu-right d--flex gap-24 bg-color--gray-lightest megamenu-padding">
                  {%- if block.url != blank and block.heading != blank and block.image != blank -%}
                    {%- render 'theme-header-block-desktop'
                    url: block.url,
                    image: block.image,
                    heading: block.heading,
                    pretitle: block.pretitle,
                    cta: block.cta -%}
                  {%- endif -%}
                  {%- if block.url_two != blank and block.heading_two != blank and block.image_two != blank -%}
                    {%- render 'theme-header-block-desktop'
                    url: block.url_two,
                    image: block.image_two,
                    heading: block.heading_two,
                    pretitle: block.pretitle_two,
                    cta: block.cta_two -%}
                  {%- endif -%}
                </div>
              {%- endif -%}
            </div>
          </li>
        {%- else -%}
          <li class="ml-22 mr-22 color--black">
            <a href="{{ link.url }}" class="menu-nav-link link-menu text--semibold d--inline-flex justify--center lg-up--align-items-center gap-4">
              {{- link.title -}}
            </a>
          </li>
        {%- endif -%}
      {%- endfor -%}
    </ul>
  </nav>
  <div class="menu-header-right d--flex align-items--center justify--end gap-16">
    <details class="search-details search-column">
      <summary class="header__icon line-height-0 menu-nav-link header__icon--search header__icon--summary relative modal__toggle" aria-haspopup="dialog" aria-label="{{ 'layout.header.search.toggle' | t }}" data-search-toggle>
        {%- render 'icons-sprite-icon' id: 'icon-search', size: 14, class: 'icon-search modal__toggle-open' -%}
      </summary>
      <div class="search-modal bg-color--white modal__content" role="dialog" aria-modal="true" aria-label="{{ 'layout.header.search.title' | t }}">
        <predictive-search class="search-modal__content search-modal__content-bottom relative" tabindex="-1">
          <div class="search-modal__header sticky bg-color--white">
            <button type="button" class="close-search-mobile md-up--hide" aria-label="{{ 'accessibility.close' | t }}">
              {%- render 'icons-sprite-icon' id: 'icon-close', size: 15 -%}
            </button>
            <form action="{{ routes.search_url }}" method="get" role="search">
              <div class="search-input-field d--flex align-items--center width--100">
                {%- render 'icons-sprite-icon' id: 'icon-search', size: 18, class: 'icon-search' -%}
                <label for="Search" class="visually-hidden">{{ 'layout.header.search.placeholder' | t }}</label>
                <input id="Search" type="search"
                  name="q" value="" role="combobox"
                  placeholder="{{ 'layout.header.search.placeholder' | t }}"
                  aria-expanded="false"
                  aria-owns="predictive-search-results"
                  aria-controls="predictive-search-results"
                  aria-haspopup="listbox"
                  aria-autocomplete="list"
                >
                <input name="type" type="hidden" value="product">
                <input name="options[prefix]" type="hidden" value="last">
              </div>
            </form>
          </div>
          {%- if section.settings.search_popular.links.size > 0 -%}
            <div class="popular-search-list search-modal__block">
              <p class="search-modal__heading text--bold" id="popular-search-links">
                {{- section.settings.search_popular_title | default: "Popular" -}}
              </p>
              <ul class="search-suggestions v-stack gap-16 list-unstyled" role="listbox" aria-labelledby="popular-search-links">
                {%- for link in section.settings.search_popular.links -%}
                  <li role="option">
                    <a class="hover-underline" href="{{ link.url }}">
                      {{- link.title -}}
                    </a>
                  </li>
                {%- endfor -%}
              </ul>
            </div>
          {%- endif -%}
          <div id="predictive-search" class="search-modal__block" tabindex="-1"></div>
        </predictive-search>
      </div>
    </details>
    <div class="cart-section-column">
      <a href="{{ routes.cart_url }}" class="header__icon--cart d--inline-flex lg-up--align-items-center justify--center gap-10">
        <div class="cart-text text--semibold" aria-hidden="true">
          {{- 'layout.header.cart.title' | t -}}
        </div>
        <div class="cart-count-bubble" id="cart-icon-bubble" aria-label="{{ 'layout.header.cart.cart_count' | t: count: cart.item_count }}">
          {{- cart.item_count -}}
        </div>
      </a>
    </div>
  </div>
</div>
<div id="sidebar-menu" class="lg-up--hide" aria-hidden="true">
  <button class="sidebar-menu__close bg-color--black color--white round flex-center" id="close-sidebar-button" aria-label="{{ 'accessibility.close' | t }}">
    {%- render 'icons-sprite-icon' id: 'icon-close', size: 15 -%}
  </button>
  <div class="sidebar-menu__panel d--flex flex-column bg-color--white">
    <div class="mobile-logo width--100 sidebar-menu__block sidebar-menu__block--border-b relative">
      <img class="header-logo" src="{{ 'logo-tcg.svg' | asset_url }}" width="126" height="20" alt="{{ shop.name | escape }}">
    </div>
    <nav aria-label="Sidebar menu" aria-hidden="true" class="sidebar-menu__block lg-up--hide">
      <ul class="d--grid gap-24 list-unstyled">
        {%- for link in section.settings.menu.links -%}
          {%- if link.links.size > 0 -%}
            <li class="color--black">
              <button class="open-sub-links menu-nav-link drowpdown-menu width--100 flex-between gap-10 text--semibold"  aria-controls="sidebar-submenu-{{ forloop.index }}">
                {{- link.title -}}
                {%- render 'icons-sprite-icon', id: 'icon-caret', size: 13 -%}
              </button>
              <div id="sidebar-submenu-{{ forloop.index }}" class="mega-menu sidebar-menu__panel d--flex flex-column sub-menu-{{ forloop.index }} bg-color--white {%- for childlink in link.links -%} {% if childlink.title != 'Column' %} {%- if childlink.links == blank -%} flex-column {%- endif -%} {% break %}{%- endif -%} {%- endfor -%}">
                <div class="mobile-back-container sidebar-menu__block sidebar-menu__block--border-b relative width--100">
                  <button class="close-sub-links text--semibold" aria-label="Back to top level menu">
                    {%- render 'icons-sprite-icon', id: 'icon-caret', size: 13, class: 'rotate--180' %} Home
                  </button>
                </div>
                <nav class="sidebar-menu__block v-stack gap-24 list-unstyled {%- for childlink in link.links -%} {% if childlink.title != 'Column' %} {%- if childlink.links == blank -%} flex-column {%- endif -%} {% break %}{%- endif -%} {%- endfor -%}" role="list">
                  <a href="{{ link.url }}" class="d--block text--semibold">
                    {{- link.title -}}
                  </a>
                {%- for childlink in link.links -%}
                  {%- if childlink.links.size > 0 -%}
                    {%- for grandchild_link in childlink.links -%}
                      <a class="link-submenu d--block" href="{{ grandchild_link.url }}"{% if grandchildlink.current %} aria-current="page"{% endif %}>
                        {{- grandchild_link.title -}}
                      </a>
                    {%- endfor -%}
                  {%- else -%}
                    <a href="{{ childlink.url }}" class="d--block"{% if childlink.current %} aria-current="page"{% endif %}>
                      {{- childlink.title -}}
                    </a>
                  {%- endif -%}
                {%- endfor -%}
              </nav>
              {%- assign block = blockSettings | where: 'title', link.title | first -%}
              <div class="mobile-megamenu-bottom mt-40 height--100 bg-color--gray-light">
                {%- if block.url != blank and block.heading != blank and block.image != blank -%}
                  {%- render 'theme-header-block-mobile'
                  url: block.url,
                  image: block.image,
                  heading: block.heading,
                  pretitle: block.pretitle,
                  cta: block.cta -%}
                {%- endif -%}
                {%- if block.url_two != blank and block.heading_two != blank and block.image_two != blank -%}
                  {%- render 'theme-header-block-mobile'
                  url: block.url_two,
                  image: block.image_two,
                  heading: block.heading_two,
                  pretitle: block.pretitle_two,
                  cta: block.cta_two -%}
                {%- endif -%}
              </div>
            </div>
          </li>
        {%- else -%}
          <li class="color--black">
            <a href="{{ link.url }}" class="menu-nav-link link-menu text--semibold d--inline-flex justify--center gap-4">
              {{- link.title -}}
            </a>
          </li>
        {%- endif -%}
      {%- endfor -%}
      </ul>
    </nav>
    <div class="mobile-bottom-links sidebar-menu__block mt-30 v-stack gap-24">
      {%- for link in section.settings.menu_mobile.links -%}
        {%- if link.title == 'Account' -%}
          <a class="d--block" href="{{ routes.account_url }}">
            {%- liquid if customer
              echo 'layout.header.account.title' | t
            else
              echo 'layout.header.account.login' | t
            endif -%}
          </a>
        {%- else -%}
          <a class="d--block" href="{{ link.url }}">
            {{- link.title -}}
          </a>
        {%- endif -%}
      {%- endfor -%}
      <details class="sidebar-menu__border-top relative localization-selector">
        <summary class="flex-between">
          {%- assign current_market = shop.metaobjects.language_and_currency_option.values | where: 'subfolder',request.locale.root_url | first -%}
          <span class="d--flex align-items--center gap-10 text--semibold">
            {%- render 'icons-sprite-icon' id: 'icon-globe', size: 22 -%}
            <span class="hover-underline">
              {{- current_market.link_text.value -}}
            </span>
          </span>
          {%- render 'icons-sprite-icon', id: 'icon-caret', size: 13, class: 'rotate--90' -%}
        </summary>
        <div class="localization-selector__menu mt-10">
          {%- for market in shop.metaobjects.language_and_currency_option.values -%}
            {%- assign subfolder = market.subfolder.value | append: '/' -%}
            <a class="d--flex align-items--center width--100 gap-10 mt-5" href="{{ request.path | replace_first: request.locale.root_url, subfolder  | replace: '///','/' | replace: '//','/' }}">
              {%- if market.icon -%}
                <img class="flex-shrink-0" srcset="{{ market.icon | image_url: width: 22 }} 22w, {{ market.icon | image_url: width: 44 }} 44w" sizes="22px" width="22" alt="{{ market.link_text.value | escape }}" loading="lazy">
              {%- else -%}
                {%- render 'icons-sprite-icon' id: 'icon-globe', size: 22, class: 'flex-shrink-0' -%}
              {%- endif -%}
              <span class="hover-underline">
                {{- market.link_text.value -}}
              </span>
            </a>
          {%- endfor -%}
        </div>
      </details>
    </div>
  </div>
</div>

{% schema %}
{
  "name": "Header",
  "class":"bg-color--white navbar sticky",
  "settings": [
    {
      "type": "link_list",
      "id": "menu",
      "label": "Main Menu"
    },
    {
      "type": "link_list",
      "id": "menu_mobile",
      "label": "Mobile Login/Support Navigation"
    },
    {
      "type": "header",
      "content": "Popular Search Links"
    },
    {
      "type": "link_list",
      "id": "search_popular",
      "label": "Popular Search Menu"
    },
    {
      "type": "text",
      "id": "search_popular_title",
      "label": "Popular Search Heading",
      "default": "Popular"
    }
  ],
  "blocks": [
    {
      "type": "megamenu",
      "name": "Megamenu",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Menu item",
          "info": "Must match link text"
        },
        {
          "type": "header",
          "content": "Content Block 1"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Content Block 1 Image"
        },
        {
          "type": "url",
          "id": "url",
          "label": "Content Block 1 URL"
        },
        {
          "type": "text",
          "id": "pretitle",
          "label": "Content Block 1 Pre-Title"
        },
        {
          "type": "text",
          "id": "heading",
          "label": "Content Block 1 Title"
        },
        {
          "type": "text",
          "id": "cta",
          "label": "Content Block 1 CTA",
          "default": "Shop Now"
        },
        {
          "type": "header",
          "content": "Content Block 2"
        },
        {
          "type": "image_picker",
          "id": "image_two",
          "label": "Content Block 2 Image"
        },
        {
          "type": "url",
          "id": "url_two",
          "label": "Content Block 2 URL"
        },
        {
          "type": "text",
          "id": "pretitle_two",
          "label": "Content Block 2 Pre-Title"
        },
        {
          "type": "text",
          "id": "heading_two",
          "label": "Content Block 2 Title"
        },
        {
          "type": "text",
          "id": "cta_two",
          "label": "Content Block 2 CTA",
          "default": "Shop Now"
        }
      ]
    }
  ]
}
{% endschema %}
